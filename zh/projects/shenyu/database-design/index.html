<!doctype html><html><head><title>Apache ShenYu Admin数据结构 · ShenYu</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="zh"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link style=font-size:25px;margin-right:50px href=/zh/><img class=logo src=/img/logo/apache-shenyu.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/zh/projects/shenyu/download/><span>下载</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/projects/shenyu/overview/><span>文档</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/community/code-conduct/><span>社区</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/news/><span>新闻</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/awesome/><span>Awesome</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/shenyu/database-design/><span>English</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/zh/projects/shenyu/download/>下载</a>
<a class=navbar-item href=/zh/projects/shenyu/overview/>文档</a>
<a class=navbar-item href=/zh/community/code-conduct/>社区</a>
<a class=navbar-item href=/zh/news/>新闻</a>
<a class=navbar-item href=/zh/awesome/>Awesome</a>
<span class="navbar-item nav-hover"><a>Links</a><div class=dropdown-menu><a class=dropdown-item href=https://www.apache.org/>Apache Software Foundation</a>
<a class=dropdown-item href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=dropdown-item href=https://www.apache.org/>License</a>
<a class=dropdown-item href=http://www.apache.org/events/current-event>Apache Events</a>
<a class=dropdown-item href=https://www.apache.org/licenses/>Security</a>
<a class=dropdown-item href=http://www.apache.org/foundation/sponsorship.html>Sponsor and Donate</a>
<a class=dropdown-item href=http://www.apache.org/foundation/thanks.html>Thanks</a></div></span></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/shenyu/database-design/>En</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"><div id=js-drawer class=ss-toc><div id=js-drawer-handle class=drawer-handle><svg class="icon icon-menu" aria-hidden="true"><use xlink:href="#icon-menu"/></svg><svg class="icon icon-close" aria-hidden="true"><use xlink:href="#icon-close"/></svg></div><div class=drawer-body><div class=header title="Apache ShenYu是一个异步的，高性能的，跨语言的，响应式的API网关。">Apache ShenYu(current)<div class="ss-toc-list-card -hidden-mobile"><svg class="icon -hidden-mobile" aria-hidden="true"><use xlink:href="#icon-menu1"/></svg><div class=ss-tooltip><div class=toc-list><h4 class=title>主要项目</h4><ul class=list><li class=item><a href=/zh/projects/shenyu/overview>Apache ShenYu(current)</a></li><li class=item><a href=/zh/projects/shenyu-2.3.0/overview>Apache ShenYu(2.3.0)</a></li></ul></div></div></div></div><div class=body><ul class=leaf-section><li class=item><div class=link><a title=介绍 href=/zh/projects/shenyu/overview>介绍</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=设计文档>设计文档</a></div><ul class=leaf-section><li class=item><div class="link -current"><a title="Apache ShenYu Admin数据结构" href=/zh/projects/shenyu/database-design>Apache ShenYu Admin数据结构</a></div></li><li class=item><div class=link><a title=数据同步 href=/zh/projects/shenyu/data-sync>数据同步</a></div></li><li class=item><div class=link><a title=应用客户端接入 href=/zh/projects/shenyu/register-center-design>应用客户端接入</a></div></li><li class=item><div class=link><a title=流量控制 href=/zh/projects/shenyu/flow-control>流量控制</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=快速开始>快速开始</a></div><ul class=leaf-section><li class=item><div class=link><a title=环境搭建 href=/zh/projects/shenyu/shenyu-set-up>环境搭建</a></div></li><li class=item><div class=link><a title=Dubbo代理 href=/zh/projects/shenyu/quick-start-dubbo>Dubbo代理</a></div></li><li class=item><div class=link><a title=Http代理 href=/zh/projects/shenyu/quick-start-http>Http代理</a></div></li><li class=item><div class=link><a title=gRPC代理 href=/zh/projects/shenyu/quick-start-grpc>gRPC代理</a></div></li><li class=item><div class=link><a title="Spring Cloud代理" href=/zh/projects/shenyu/quick-start-springcloud>Spring Cloud代理</a></div></li><li class=item><div class=link><a title=Sofa代理 href=/zh/projects/shenyu/quick-start-sofa>Sofa代理</a></div></li><li class=item><div class=link><a title=Tars代理 href=/zh/projects/shenyu/quick-start-tars>Tars代理</a></div></li><li class=item><div class=link><a title=Motan代理 href=/zh/projects/shenyu/quick-start-motan>Motan代理</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=用户文档>用户文档</a></div><ul class=leaf-section><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=admin使用>admin使用</a></div><ul class=leaf-section><li class=item><div class=link><a title=插件配置 href=/zh/projects/shenyu/plugin-handle-explanation>插件配置</a></div></li><li class=item><div class=link><a title=选择器和规则配置 href=/zh/projects/shenyu/selector-and-rule>选择器和规则配置</a></div></li><li class=item><div class=link><a title=字典配置 href=/zh/projects/shenyu/dictionary-management>字典配置</a></div></li><li class=item><div class=link><a title=权限管理 href=/zh/projects/shenyu/authority-management>权限管理</a></div></li></ul></li><li class=item><div class=link><a title=Http代理 href=/zh/projects/shenyu/http-proxy>Http代理</a></div></li><li class=item><div class=link><a title=Dubbo代理 href=/zh/projects/shenyu/dubbo-proxy>Dubbo代理</a></div></li><li class=item><div class=link><a title=SpringCloud代理 href=/zh/projects/shenyu/spring-cloud-proxy>SpringCloud代理</a></div></li><li class=item><div class=link><a title=Sofa代理 href=/zh/projects/shenyu/sofa-rpc-proxy>Sofa代理</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=插件集合>插件集合</a></div><ul class=leaf-section><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Http 处理">Http 处理</a></div><ul class=leaf-section><li class=item><div class=link><a title=Divide插件 href=/zh/projects/shenyu/divide-plugin>Divide插件</a></div></li><li class=item><div class=link><a title=Rewrite插件 href=/zh/projects/shenyu/rewrite-plugin>Rewrite插件</a></div></li><li class=item><div class=link><a title=Redirect插件 href=/zh/projects/shenyu/redirect-plugin>Redirect插件</a></div></li><li class=item><div class=link><a title=Request插件 href=/zh/projects/shenyu/request-plugin>Request插件</a></div></li><li class=item><div class=link><a title=Context-path插件 href=/zh/projects/shenyu/context-path-plugin>Context-path插件</a></div></li><li class=item><div class=link><a title=Param-mapping插件 href=/zh/projects/shenyu/param-mapping-plugin>Param-mapping插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="RPC 代理">RPC 代理</a></div><ul class=leaf-section><li class=item><div class=link><a title=Dubbo插件 href=/zh/projects/shenyu/dubbo-plugin>Dubbo插件</a></div></li><li class=item><div class=link><a title="Spring Cloud插件" href=/zh/projects/shenyu/spring-cloud-plugin>Spring Cloud插件</a></div></li><li class=item><div class=link><a title=Sofa插件 href=/zh/projects/shenyu/sofa-plugin>Sofa插件</a></div></li><li class=item><div class=link><a title=gRPC插件 href=/zh/projects/shenyu/grpc-plugin>gRPC插件</a></div></li><li class=item><div class=link><a title=Tars插件 href=/zh/projects/shenyu/tars-plugin>Tars插件</a></div></li><li class=item><div class=link><a title=Motan插件 href=/zh/projects/shenyu/motan-plugin>Motan插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=熔断和限流>熔断和限流</a></div><ul class=leaf-section><li class=item><div class=link><a title=Hystrix插件 href=/zh/projects/shenyu/hystrix-plugin>Hystrix插件</a></div></li><li class=item><div class=link><a title=Sentinel插件 href=/zh/projects/shenyu/sentinel-plugin>Sentinel插件</a></div></li><li class=item><div class=link><a title=Resilience4j插件 href=/zh/projects/shenyu/resilience4j-plugin>Resilience4j插件</a></div></li><li class=item><div class=link><a title=RateLimiter插件 href=/zh/projects/shenyu/rate-limiter-plugin>RateLimiter插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=权限认证>权限认证</a></div><ul class=leaf-section><li class=item><div class=link><a title=Waf插件 href=/zh/projects/shenyu/waf-plugin>Waf插件</a></div></li><li class=item><div class=link><a title=Sign插件 href=/zh/projects/shenyu/sign-plugin>Sign插件</a></div></li><li class=item><div class=link><a title=JWT插件 href=/zh/projects/shenyu/jwt-plugin>JWT插件</a></div></li><li class=item><div class=link><a title="OAuth 2插件" href=/zh/projects/shenyu/oauth2-plugin>OAuth 2插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=可观测性>可观测性</a></div><ul class=leaf-section><li class=item><div class=link><a title=Monitor插件 href=/zh/projects/shenyu/monitor-plugin>Monitor插件</a></div></li><li class=item><div class=link><a title=Logging插件 href=/zh/projects/shenyu/logging-plugin>Logging插件</a></div></li></ul></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=开发者文档>开发者文档</a></div><ul class=leaf-section><li class=item><div class=link><a title=自定义filter href=/zh/projects/shenyu/custom-filter>自定义filter</a></div></li><li class=item><div class=link><a title=自定义插件 href=/zh/projects/shenyu/custom-plugin>自定义插件</a></div></li><li class=item><div class=link><a title=文件上传下载 href=/zh/projects/shenyu/file-and-image>文件上传下载</a></div></li><li class=item><div class=link><a title=自定义解析IP与Host href=/zh/projects/shenyu/custom-parsing-ip-and-host>自定义解析IP与Host</a></div></li><li class=item><div class=link><a title=自定义返回结果 href=/zh/projects/shenyu/custom-result>自定义返回结果</a></div></li><li class=item><div class=link><a title=自定义签名插件算法与验证 href=/zh/projects/shenyu/custom-sign-algorithm>自定义签名插件算法与验证</a></div></li><li class=item><div class=link><a title=多语言http客户端接入 href=/zh/projects/shenyu/developer-shenyu-client>多语言http客户端接入</a></div></li><li class=item><div class=link><a title=线程模型 href=/zh/projects/shenyu/thread>线程模型</a></div></li><li class=item><div class=link><a title=shenyu调优 href=/zh/projects/shenyu/shenyu-optimize>shenyu调优</a></div></li><li class=item><div class=link><a title=SPI href=/zh/projects/shenyu/spi-design>SPI</a></div></li></ul></li><li class=item><div class=link><a title=版本发布 href=/zh/projects/shenyu/change-log>版本发布</a></div></li><li class=item><div class=link><a title=文档下载 href=/zh/projects/shenyu/download>文档下载</a></div></li></ul></div></div></div></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>Apache ShenYu Admin数据结构</h1><a class="edit-button -hidden-mobile" href=https://github.com/apache/incubator-shenyu-website/edit/main/content/zh/projects/shenyu/database-design/index.md>编辑</a></div><div class=meta>更新时间: 2021-07-04</div></div><article class=typo><h2 id=插件设计>插件设计</h2><ul><li>插件采用数据库设计，来存储插件，选择器，规则配置数据，以及对应关系。</li><li>数据库表 UML 类图:</li></ul><p><img src=/img/shenyu/db/shenyu-db.png alt></p><ul><li><p>设计详解:</p><ul><li><p>一个插件对应多个选择器，一个选择器对应多个规则。</p></li><li><p>一个选择器对应多个匹配条件，一个规则对应多个匹配条件。</p></li><li><p>每个规则在对应插件下，不同的处理表现为 handle 字段，handle 字段就是一个 json 字符串。具体的可以在 shenyu-admin 使用过程中进行查看。</p></li></ul></li></ul><h2 id=资源权限设计>资源权限设计</h2><ul><li><p>资源代表的是 shenyu-admin 用户后台中的菜单或者按钮。</p></li><li><p>资源权限数据表用来存储用户名称、角色、资源数据以及对应关系。</p></li><li><p>数据库UML类图：</p></li></ul><p><img src=/img/shenyu/db/shenyu-permission-db.png alt></p><ul><li>设计详解:<ul><li>一个用户对应多个角色,一个角色对应多个资源。</li></ul></li></ul><h2 id=数据权限设计>数据权限设计</h2><ul><li>数据权限数据表用来存储用户，选择器、规则对应的关系。</li><li>数据库 UML 类图</li></ul><p><img src=/img/shenyu/db/data_permission.png alt=数据权限表设计></p><ul><li>设计详解<ul><li>数据权限的表为： <code>data_permission</code>; 其中一个用户对应多条数据权限。</li><li>数据权限表中字段 <code>data_type</code> 区分不同的类型数据， 具体对应关系如下：0 -&gt; 选择器, 1 -&gt; 规则。</li><li>数据权限表中字段 <code>data_id</code> 存放相应类型的主键id。<br></li></ul></li></ul><h2 id=元数据设计>元数据设计</h2><ul><li><p>在数据库中，新增了一张表，然后通过数据同步的方案，会把这张表的数据同步到网关JVM内存。</p></li><li><p>表结构如下：</p></li></ul><pre><code class=language-sql>CREATE TABLE  IF NOT EXISTS `meta_data` (
  `id` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'id',
  `app_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '应用名称',
  `path` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '路径,不能重复',
  `path_desc` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '路径描述',
  `rpc_type` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'rpc类型',
  `service_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT '服务名称',
  `method_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT '方法名称',
  `parameter_types` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT '参数类型 多个参数类型 逗号隔开',
  `rpc_ext` varchar(1024) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'rpc的扩展信息，json格式',
  `date_created` datetime(0) NOT NULL COMMENT '创建时间',
  `date_updated` datetime(0) NOT NULL ON UPDATE CURRENT_TIMESTAMP(0) COMMENT '更新时间',
  `enabled` tinyint(4) NOT NULL DEFAULT 0 COMMENT '启用状态',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Dynamic;

</code></pre><ul><li><p>元数据设计，目前最主要的是对 dubbo 的泛化调用上进行使用。</p></li><li><p>我重点讲一下 <code>path</code> 字段，在请求网关的时候，会根据你的 path 字段来匹配到一条数据，然后进行后续的流程。</p></li><li><p>重点讲一下 <code>rpc_ext</code>字段，如果是 dubbo 类型的服务接口，如果服务接口设置了 group 和 version 字段的时候，会存在这个字段。</p></li><li><p>dubbo 类型 字段结构是 如下，那么存储的就是 json 格式的字符串。</p></li></ul><pre><code class=language-java>   public static class RpcExt {
      private String group;
      private String version;
      private String loadbalance;
      private Integer retries;
      private Integer timeout;
   }
</code></pre><h4 id=元数据存储>元数据存储</h4><ul><li><p>每个 dubbo 接口方法，对应一条元数据。</p></li><li><p>springcloud 协议，只会存储一条数据， path为 <code>/contextPath/**</code>。</p></li><li><p>http 服务，则不会有任何数据。</p></li></ul></article></main></div><footer class=ss-footer><div class=container><div class=links><div class="cate  -show-mobile"><h2 class=cate-title>Apache</h2><a class=link href=https://www.apache.org/>Foundation</a>
<a class=link href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=link href=https://www.apache.org/licenses/>License</a>
<a class=link href=https://www.apache.org/security/>Security</a>
<a class=link href=http://www.apache.org/events/current-event>Events</a>
<a class=link href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a>
<a class=link href=http://www.apache.org/foundation/thanks.html>Thanks</a></div><div class=cate><h2 class=cate-title>资源</h2><a class=link href=https://github.com/apache/incubator-shenyu>Github</a>
<a class=link href=/zh/projects/shenyu/overview/>文档</a>
<a class=link href=mailto://dev-subscribe@shenyu.apache.org>订阅邮件</a>
<a class=link href=https://lists.apache.org/list.html?dev@shenyu.apache.org>邮件归档</a></div><div class=cate><h2 class=cate-title>参与进来</h2><a class=link href=https://github.com/apache/incubator-shenyu/issues/new>反馈</a>
<a class=link href=/zh/community>社区</a>
<a class=link href=/zh/news>新闻</a></div></div></div><div class=copyright><p>Copyright © 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.
Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache EventMesh logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.
Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator.
Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects.
While incubation status is not necessarily a reflection of the completeness or stability of the code,
it does indicate that the project has yet to be fully endorsed by the ASF.</p></div></footer></body></html>